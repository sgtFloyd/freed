:ruby
  def time_ago(time)
    difference = (Time.now - Time.at(time.to_i)).to_i
    difference -= (seconds = difference % 60)
    difference -= 60 * (minutes = difference / 60)
    minutes -= 60 * (hours = minutes / 60)
    "#{pad(hours)}:#{pad(minutes)}:#{pad(seconds)}"
  end

  def pad(i)
    i.to_i < 10 ? "0#{i}" : i.to_s
  end

%html
  %head
    %title Freed

    %script{ type: 'text/javascript', src: 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js' }

    :javascript
      $(document).ready(function() {
        // delete feeds
        $('.delete').click(function(){
          var feed_id = $(this).closest('tr').attr('id');
          $.ajax({
            url: '/feed/' + feed_id,
            type: 'DELETE',
            success: $('#'+feed_id).remove()
          });
        });

        // show delete link on hover
        $('tr').hover(
          function(){ $(this).find('.delete').show(); },
          function(){ $(this).find('.delete').hide(); }
        );

      });

    :css
      td{padding: 0px 25px}
      .delete{text-decoration: none; display: none}

  %body{ style: 'font-family:monospace' }

    %p
      %form{ action: '/feed', method: :post }
        %input{ type: 'text', name: 'feed_url', placeholder: 'Feed Url', size: 50 }
        %input{ type: 'text', name: 'notify_email', placeholder: 'Your Email', size: 50 }
        %select{ name: 'frequency' }
          %option{ disabled: true, selected: true } Frequency
          %option{ value: 1} &nbsp;&nbsp;1 minute
          %option{ value: 2} &nbsp;&nbsp;2 minutes
          %option{ value: 5 } &nbsp;&nbsp;5 minutes
          %option{ value: 10} &nbsp;&nbsp;10 minutes
          %option{ value: 30} &nbsp;&nbsp;30 minutes
          %option{ value: 60} &nbsp;&nbsp;1 hour
          %option{ value: 1440} &nbsp;&nbsp;24 hours
        %input{ type: 'submit' }

    %p
      %table
        %th Feed URL
        %th Email Address
        %th Verified?
        %th Frequency
        %th Last Checked
        %th
        - feeds.each do |feed_id, feed|
          %tr{ id: feed_id }
            %td= feed['feed_url']
            %td= feed['notify_email']
            %td= feed['email_verified'] == 'true' ? "Yes" : "<b>No</b>"
            %td= feed['frequency'] + (feed['frequency'] == '1' ? ' minute' : ' minutes')
            %td{ 'data-last-digest' => feed['last_digest'] }
              = time_ago(feed['last_checked']) + " ago"
            %td
              %a.delete{ href:'javascript:' } x

